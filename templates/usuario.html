{% extends "base.html" %}

{% block content %}

<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<div id="toastTemplate" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" style="display: none;">
    <div class="d-flex">
        <div class="toast-body">
            <strong id="toastTitle" class="me-auto"></strong>
            <div id="toastBody"></div>
        </div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
</div>

<h1 class="text-center my-4"><i class="bi bi-person-badge-fill text-success"></i> Gestión de Usuarios</h1>
<hr>

<div class="row">
    <!-- Columna del Formulario -->
    <div class="col-md-4">
        <div class="card mb-3 shadow-sm border-0">
            <div class="card-header bg-success text-white fw-bold" id="cardTitle">
                <i class="bi bi-person-plus-fill me-2"></i>Nuevo Usuario
            </div>
            <div class="card-body bg-light">
                <form id="formularioUsuario" method="POST" action="/crear_usuario">
                    <div class="mb-3">
                        <label for="usuario" class="form-label fw-bold">Nombre de Usuario</label>
                        <input type="text" class="form-control" id="usuario" name="usuario" required autocomplete="username" placeholder="Ej: admin">
                    </div>
                    <div class="mb-3">
                        <label for="contrasena" class="form-label fw-bold">Contraseña</label>
                        <input type="password" class="form-control" id="contrasena" name="contrasena" required autocomplete="new-password" placeholder="******">
                        <div id="passwordHelp" class="form-text d-none text-warning">Dejar en blanco para mantener la actual.</div>
                    </div>
                    <div class="mb-3">
                        <label for="rol" class="form-label fw-bold">Rol / Permisos</label>
                        <select class="form-control" id="rol" name="rol" required>
                            <option value="" selected disabled>Seleccione un rol...</option>
                            <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                            <option value="USUARIO">USUARIO</option>
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" id="btnCancelar" class="btn btn-secondary me-md-2" style="display: none;">Cancelar</button>
                        <button type="submit" id="btnSubmit" class="btn btn-success">Crear Usuario</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Columna de la Tabla -->
    <div class="col-md-8">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-dark text-white fw-bold">
                <i class="bi bi-list-ul me-2"></i>Listado de Usuarios
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="usuarios" class="table table-striped table-hover align-middle" style="width: 100%;">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Rol</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usuario in usuarios %}
                            <tr>
                                <td>{{ usuario.id }}</td>
                                <td class="fw-bold text-primary">{{ usuario.usuario }}</td>
                                <td>
                                    {% if usuario.rol == 'ADMINISTRADOR' %}
                                        <span class="badge bg-danger">ADMINISTRADOR</span>
                                    {% else %}
                                        <span class="badge bg-info text-dark">USUARIO</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-warning btn-sm edit-usuario text-white" 
                                            data-id="{{ usuario.id }}"
                                            data-usuario="{{ usuario.usuario }}" 
                                            data-rol="{{ usuario.rol }}"
                                            title="Editar">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-usuario" 
                                            data-id="{{ usuario.id }}"
                                            title="Eliminar">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="fs-5">¿Estás seguro de que deseas eliminar este usuario?</p>
                <p class="text-muted small">El usuario perderá el acceso al sistema inmediatamente.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger px-4" id="confirmDeleteButton">Eliminar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='/js/toast.js') }}"></script>
<script src="{{ url_for('static', filename='Datatables/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='Datatables/js/buttons.print.min.js') }}"></script>
<script>
    $(document).ready(function () {
        var deleteUserId = null;
        
        $('#usuarios').DataTable({
            "language": { "url": '{{ url_for("static", filename="Datatables/plug-ins/es-ES.json") }}' },
            "paging": true,
            "searching": true,
            "ordering": true,
            "pageLength": 8,
            "dom": 'Bfrtip',
            "buttons": ['copy', 'print']
        });

        // --- LÓGICA DE EDICIÓN Y CREACIÓN ---

        // 1. Click Editar
        $('.edit-usuario').click(function (e) {
            e.preventDefault();
            
            var id = $(this).data('id');
            var usuario = $(this).data('usuario');
            var rol = $(this).data('rol');
            
            // Llenar form
            $('#usuario').val(usuario);
            $('#rol').val(rol);
            $('#contrasena').val(''); // Limpiar contraseña por seguridad
            $('#contrasena').removeAttr('required'); // Al editar, password es opcional
            $('#contrasena').attr('placeholder', 'Dejar vacío para no cambiar');
            $('#passwordHelp').removeClass('d-none'); // Mostrar ayuda
            
            // Cambiar acción
            $('#formularioUsuario').attr('action', '/editar_usuario/' + id);

            // Cambios Visuales
            $('#cardTitle').html('<i class="bi bi-pencil-square me-2"></i>Editar Usuario');
            $('#cardTitle').removeClass('bg-success').addClass('bg-warning text-dark');
            
            $('#btnSubmit').text('Guardar Cambios');
            $('#btnSubmit').removeClass('btn-success').addClass('btn-warning text-dark');
            
            $('#btnCancelar').show();
            
            // Scroll
            $('html, body').animate({
                scrollTop: $("#formularioUsuario").offset().top - 100
            }, 500);
        });

        // 2. Click Cancelar
        $('#btnCancelar').click(function() {
            resetForm();
        });

        function resetForm() {
            $('#formularioUsuario')[0].reset();
            $('#formularioUsuario').attr('action', '/crear_usuario');
            
            // Restaurar password required para creación
            $('#contrasena').attr('required', 'required');
            $('#contrasena').attr('placeholder', '******');
            $('#passwordHelp').addClass('d-none');
            
            // Restaurar visuales
            $('#cardTitle').html('<i class="bi bi-person-plus-fill me-2"></i>Nuevo Usuario');
            $('#cardTitle').removeClass('bg-warning text-dark').addClass('bg-success text-white');
            
            $('#btnSubmit').text('Crear Usuario');
            $('#btnSubmit').removeClass('btn-warning text-dark').addClass('btn-success');
            
            $('#btnCancelar').hide();
        }

        // 3. Submit
        $('#formularioUsuario').submit(function (e) {
            e.preventDefault();
            var form = $(this);
            var url = form.attr('action');
            
            $.ajax({
                url: url,
                type: 'POST',
                data: form.serialize(),
                success: function (response) {
                    var bsToast = showToast(response.message, 'success');
                    bsToast._element.addEventListener('hidden.bs.toast', function () {
                        location.reload();
                    });
                    resetForm();
                },
                error: function (xhr) {
                    var response = xhr.responseJSON;
                    showToast(response.message || 'Error en la operación', 'danger');
                }
            });
        });

        // --- ELIMINACIÓN ---
        $('.delete-usuario').click(function (e) {
            e.preventDefault();
            deleteUserId = $(this).data('id');
            var modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        });

        $('#confirmDeleteButton').click(function () {
            if (deleteUserId) {
                $.ajax({
                    url: '/eliminar_usuario/' + deleteUserId,
                    type: 'DELETE',
                    success: function (response) {
                        var bsToast = showToast(response.message, 'success');
                        bsToast._element.addEventListener('hidden.bs.toast', function () {
                            location.reload();
                        });
                    },
                    error: function (xhr) {
                        showToast('Error al eliminar usuario', 'danger');
                    }
                });
                var modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
                modal.hide();
            }
        });
    });
</script>
{% endblock %}
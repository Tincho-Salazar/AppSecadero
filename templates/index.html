{% extends 'base.html' %}

{% block style %}
<style>
  /* Estilos de Tarjetas KPI */
  .kpi-card {
    background: #fff;
    border-radius: 15px;
    padding: 20px;
    height: 100%;
    position: relative;
    overflow: hidden;
    border-left: 5px solid transparent;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  /* Colores de estado */
  .kpi-card.primary { border-color: #2e7d32; } /* Verde Fuerte */
  .kpi-card.info { border-color: #0288d1; }    /* Azul */
  .kpi-card.warning { border-color: #fbc02d; } /* Amarillo */
  .kpi-card.danger { border-color: #d32f2f; }  /* Rojo */

  .kpi-icon {
    position: absolute;
    right: -10px;
    bottom: -10px;
    font-size: 5rem;
    opacity: 0.1;
    transform: rotate(-15deg);
  }

  .kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #37474f;
  }

  .kpi-label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #78909c;
    font-weight: 600;
  }

  /* Estilos para Listas de Estadísticas */
  .stat-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #cfd8dc;
  }

  .stat-list-item:hover {
    background-color: #e8f5e9;
    border-left-color: #2e7d32;
  }

  .stat-val { font-weight: bold; color: #2e7d32; }
  
  /* Animación de Carga (Skeleton) */
  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    color: transparent !important;
    border-radius: 4px;
    min-height: 20px;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="fw-bold text-dark"><i class="bi bi-bar-chart-line text-success"></i> Monitor de Planta</h2>
        <p class="text-muted">Visualización en tiempo real del proceso de secado y empaquetado.</p>
    </div>
</div>

<!-- Sección 1: KPIs Superiores (Tiempo Real) -->
<div class="row g-4 mb-5">
    <!-- Producto Actual -->
    <div class="col-md-6 col-xl-3">
        <div class="kpi-card primary shadow-sm">
            <div class="kpi-label">Producto en Línea</div>
            <div id="producto-actual" class="kpi-value mt-2 skeleton">Cargando...</div>
            <i class="bi bi-box-seam kpi-icon text-success"></i>
        </div>
    </div>
    
    <!-- Pesaje Actual -->
    <div class="col-md-6 col-xl-3">
        <div class="kpi-card danger shadow-sm">
            <div class="kpi-label">Último Pesaje</div>
            <div class="mt-2 d-flex align-items-baseline">
                <span id="pesaje-actual" class="kpi-value skeleton">0</span>
                <span class="ms-2 text-muted fs-5">kg</span>
            </div>
            <i class="bi bi-speedometer kpi-icon text-danger"></i>
        </div>
    </div>

    <!-- Lote -->
    <div class="col-md-6 col-xl-3">
        <div class="kpi-card info shadow-sm">
            <div class="kpi-label">Lote Actual</div>
            <div id="lote-actual" class="kpi-value mt-2 skeleton">---</div>
            <i class="bi bi-upc-scan kpi-icon text-info"></i>
        </div>
    </div>

    <!-- Contador ID Pesaje -->
    <div class="col-md-6 col-xl-3">
        <div class="kpi-card warning shadow-sm">
            <div class="kpi-label">ID Pesaje / Bolsa</div>
            <div id="pesaje-id" class="kpi-value mt-2 skeleton">---</div>
            <i class="bi bi-hash kpi-icon text-warning"></i>
        </div>
    </div>
</div>

<!-- Sección 2: Estadísticas de Texto -->
<div class="row g-4">
    <!-- Columna Izquierda: Totales Diarios -->
    <div class="col-lg-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-white border-bottom-0 pt-4">
                <h5 class="fw-bold"><i class="bi bi-calendar-check text-success me-2"></i>Acumulado Diario</h5>
            </div>
            <div class="card-body" id="total-diario">
                <!-- Skeletons iniciales -->
                <div class="skeleton p-3 mb-2"></div>
                <div class="skeleton p-3 mb-2"></div>
                <div class="skeleton p-3"></div>
            </div>
        </div>
    </div>
    
    <!-- Columna Central: Totales Mensuales -->
    <div class="col-lg-4">
         <div class="card h-100 shadow-sm">
            <div class="card-header bg-white border-bottom-0 pt-4">
                <h5 class="fw-bold"><i class="bi bi-calendar3 text-primary me-2"></i>Acumulado Mensual</h5>
            </div>
            <div class="card-body" id="total-mensual">
                <div class="skeleton p-3 mb-2"></div>
                <div class="skeleton p-3 mb-2"></div>
                <div class="skeleton p-3"></div>
            </div>
        </div>
    </div>

    <!-- Columna Derecha: Hoja Verde y Rendimiento -->
    <div class="col-lg-4">
        <div class="card h-100 shadow-sm border-success">
           <div class="card-header bg-success text-white pt-3 pb-3">
               <h5 class="fw-bold mb-0"><i class="bi bi-leaf me-2"></i>Materia Prima (Hoja Verde)</h5>
           </div>
           <div class="card-body">
               <div id="total-hoja-verde">
                   <div class="skeleton mb-2" style="height: 40px;"></div>
               </div>
               <hr>
               <h6 class="text-muted text-uppercase fw-bold text-center mt-3">Rendimiento Global</h6>
               <div id="Rendimiento" class="text-center">
                   <div class="display-6 fw-bold text-success skeleton" style="height: 50px; width: 50%; margin: 0 auto;"></div>
               </div>
           </div>
       </div>
   </div>
</div>

<!-- Sección 3: Gráficos (Solo para Admin) -->
{% if 'usuario' in session and session['rol'] == 'ADMINISTRADOR' %}
<div class="row mt-5 g-4">
    <!-- Gráfico Bokeh: Pesajes por Hora -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light rounded-top">
                    <h5 class="fw-bold m-0 text-secondary"><i class="bi bi-bar-chart me-2"></i>Pesajes por Hora</h5>
                    
                    <!-- Contenedor del Datepicker e Indicador -->
                    <div class="d-flex align-items-center bg-white p-1 rounded border shadow-sm">
                        <label for="fecha-grafico-input" class="me-2 text-muted small fw-bold px-2">Ver Fecha:</label>
                        <input type="date" id="fecha-grafico-input" class="form-control form-control-sm border-0" style="width: auto; font-weight: 500;">
                        <!-- Indicador visual de actualización en tiempo real -->
                        <span id="live-indicator" class="badge bg-success ms-2 d-none animate__animated animate__pulse animate__infinite">EN VIVO</span>
                    </div>
                </div>
                <div class="ratio ratio-21x9">
                    <!-- iframe con ID para manipular desde JS -->
                    <iframe id="iframe-bokeh" src="/bokeh/pesajes" style="border:0;"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráfico Dash: Producción Mensual -->
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <iframe src="/dash/" style="width: 100%; height: 100%; min-height: 400px; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Variable global para controlar el intervalo de refresco del gráfico de Bokeh
    let refreshInterval = null;

    document.addEventListener("DOMContentLoaded", function () {
        // 1. Iniciar polling de datos numéricos (KPIs y Tablas) - Siempre activo cada 5s
        actualizarDatos();
        setInterval(actualizarDatos, 5000); 

        // 2. Lógica Inteligente para el Gráfico de Barras (Bokeh)
        const dateInput = document.getElementById('fecha-grafico-input');
        const iframe = document.getElementById('iframe-bokeh');
        const liveIndicator = document.getElementById('live-indicator');

        if (dateInput && iframe) {
            // Calcular fecha de hoy localmente
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            
            // Establecer valor inicial
            dateInput.value = todayStr;

            // Función centralizada para gestionar la actualización del gráfico
            function gestionarActualizacionGrafico() {
                const selectedDate = dateInput.value;
                if (!selectedDate) return;

                // A) Cargar el gráfico inmediatamente (con timestamp 't' para evitar caché)
                try {
                    // Evitar error en modo vista previa si la URL base no es http/https
                    if (window.location.protocol === 'blob:' || window.location.protocol === 'file:') return;
                    iframe.src = `/bokeh/pesajes?fecha=${selectedDate}&t=${new Date().getTime()}`;
                } catch(e) { console.log("Modo preview detectado"); }

                // B) Lógica de Intervalo: 
                // Solo si la fecha seleccionada es HOY, activamos la recarga automática.
                if (selectedDate === todayStr) {
                    if (!refreshInterval) {
                        console.log("Iniciando auto-refresh de gráfico (Modo EN VIVO)");
                        refreshInterval = setInterval(() => {
                            try {
                                // Recarga silenciosa del iframe
                                iframe.src = `/bokeh/pesajes?fecha=${todayStr}&t=${new Date().getTime()}`;
                            } catch(e){}
                        }, 60000); // 60 segundos
                    }
                    // Mostrar indicador visual "EN VIVO"
                    if(liveIndicator) liveIndicator.classList.remove('d-none');
                } else {
                    // Si es una fecha pasada, no necesitamos refrescar
                    if (refreshInterval) {
                        console.log("Deteniendo auto-refresh (Fecha Histórica)");
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                    // Ocultar indicador visual
                    if(liveIndicator) liveIndicator.classList.add('d-none');
                }
            }

            // Ejecutar al inicio (carga por defecto hoy)
            gestionarActualizacionGrafico();

            // Ejecutar cada vez que el usuario cambie la fecha
            dateInput.addEventListener('change', gestionarActualizacionGrafico);
        }
    });

    function actualizarDatos() {
        // Validación de entorno para evitar errores en consola durante desarrollo/preview
        try {
            if (window.location.protocol === 'blob:' || window.location.protocol === 'file:') return;
            // Verificar si podemos construir la URL relativa
            new URL('/api/datos', window.location.href);
        } catch (e) { return; }

        fetch('/api/datos')
            .then(r => r.json())
            .then(d => {
                // Remover skeletons (animaciones de carga) si hay datos reales
                const skeletons = document.querySelectorAll('.skeleton');
                skeletons.forEach(el => {
                    // Solo quitar la clase skeleton si el elemento ya tiene texto diferente al placeholder
                    if(el.innerText !== "Cargando..." && el.innerText !== "") el.classList.remove('skeleton');
                });

                // Actualizar valores en el DOM
                updateElement('producto-actual', d.producto_actual);
                updateElement('pesaje-actual', d.pesaje_actual);
                updateElement('lote-actual', d.lote_actual);
                updateElement('pesaje-id', d.pesaje_id);
                
                // Disparar actualización de estadísticas secundarias
                actualizarEstadisticas();
            })
            .catch(e => console.error("Error API Datos:", e));
    }

    function actualizarEstadisticas() {
        try { if (window.location.protocol === 'blob:') return; } catch(e){}

        fetch('/api/estadisticas')
            .then(r => r.json())
            .then(data => {
                // Renderizar listas de totales
                renderList('total-diario', data.total_diario, 'producto', 'total_diario');
                renderList('total-mensual', data.total_mensual, 'producto', 'total_mensual');
                
                // Actualizar Hoja Verde
                const hvDiv = document.getElementById("total-hoja-verde");
                if(hvDiv) {
                    hvDiv.innerHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <span>Ingreso Diario:</span>
                            <span class="fw-bold">${formatNum(data.total_hoja_verde_diario)} kg</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Acumulado Mensual:</span>
                            <span class="fw-bold text-success">${formatNum(data.total_hoja_verde_mensual)} kg</span>
                        </div>
                    `;
                    hvDiv.classList.remove('skeleton');
                }

                // Calcular y Actualizar Rendimiento
                const rendDiv = document.getElementById("Rendimiento");
                if(rendDiv) {
                    // Sumar total mensual de productos procesados
                    const totalProd = data.total_mensual.reduce((acc, item) => acc + parseFloat(item.total_mensual || 0), 0);
                    const totalHV = parseFloat(data.total_hoja_verde_mensual || 0);
                    
                    // Cálculo seguro (evitar división por cero)
                    const rend = totalHV > 0 ? ((totalProd / totalHV) * 100).toFixed(2) : "0.00";
                    
                    // Colorear según eficiencia
                    let colorClass = rend > 30 ? 'text-success' : (rend > 20 ? 'text-warning' : 'text-danger');
                    
                    rendDiv.innerHTML = `
                        <div class="display-4 fw-bold ${colorClass}">${rend}%</div>
                        <small class="text-muted">Prod. Seca / Hoja Verde</small>
                    `;
                }
            })
            .catch(e => console.error("Error Estadisticas:", e));
    }

    // --- Funciones Auxiliares ---

    function updateElement(id, val) {
        const el = document.getElementById(id);
        if(el) {
            el.innerText = val;
            el.classList.remove('skeleton');
        }
    }

    function renderList(containerId, list, keyLabel, keyValue) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // Si no hay lista o está vacía, mostrar mensaje
        if (!list || list.length === 0) {
            container.innerHTML = '<div class="text-muted text-center mt-3 small">Sin datos registrados hoy</div>';
            return;
        }

        let html = '';
        list.forEach(item => {
            html += `
            <div class="stat-list-item">
                <span class="text-dark small text-uppercase fw-semibold" style="font-size: 0.8rem;">${item[keyLabel]}</span>
                <span class="stat-val">${formatNum(item[keyValue])} kg</span>
            </div>`;
        });
        container.innerHTML = html;
        container.classList.remove('skeleton');
    }

    function formatNum(num) {
        if (num === undefined || num === null) return "0";
        // Formateo estilo argentino (puntos para miles, coma para decimales)
        return new Intl.NumberFormat('es-AR').format(num);
    }
</script>
{% endblock %}